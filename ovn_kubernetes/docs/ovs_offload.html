

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>OVS Hardware Offload &mdash; OpenShift SDN Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Enable Node-Local Services Access in Shared Gateway Mode" href="design/shared_gw_dgp.html" />
    <link rel="prev" title="OVN kubernetes KIND Setup" href="kind.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> OpenShift SDN Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">OpenShift SDN devel docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cno/index.html">Cluster Network Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift_sdn/index.html">OpenShift SDN</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">OVN-Kubernetes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../README.html">How to use Open Virtual Networking with Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README_MANUAL.html">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README_MANUAL.html#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README_MANUAL.html#installing-kubernetes">Installing Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kind.html">Fedora 32 setup for KIND</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.UBUNTU.html">Installing OVS and OVN on Ubuntu</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.SSL.html">Generating certificates</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.SSL.html#one-time-setup">One time setup.</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.OPENSHIFT.html">OVN overlay network on Openshift</a></li>
<li class="toctree-l2"><a class="reference internal" href="OVN-NORTHD.SSL.html">Generate signed certificates for OVN Northd</a></li>
<li class="toctree-l2"><a class="reference internal" href="ci.html">CI Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Config variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Initial setup issues.</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html#hosts-should-have-unique-node-names">Hosts should have unique node names.</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html#runtime-issues">Runtime issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="egress-firewall.html">EgressFirewall</a></li>
<li class="toctree-l2"><a class="reference internal" href="ha.html">OVN central database High-availability</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid-overlay.html">Hybrid Overlay</a></li>
<li class="toctree-l2"><a class="reference internal" href="kind.html">OVN kubernetes KIND Setup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">OVS Hardware Offload</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#supported-ethernet-controllers">Supported Ethernet controllers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#worker-node-sr-iov-configuration">Worker Node SR-IOV Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#worker-node-sr-iov-network-device-plugin-configuration">Worker Node SR-IOV network device plugin configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#worker-node-multus-cni-configuration">Worker Node Multus CNI configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploy-pod-with-ovs-hardware-offload">Deploy POD with OVS hardware-offload</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verify-hardware-offload-is-working">Verify Hardware-Offload is working</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="design/shared_gw_dgp.html">Enable Node-Local Services Access in Shared Gateway Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="ovn-kubernetes-basics.html">OVN Kubernetes Basics</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OpenShift SDN Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">OVN-Kubernetes</a> &raquo;</li>
        
      <li>OVS Hardware Offload</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/ovn_kubernetes/docs/ovs_offload.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ovs-hardware-offload">
<h1>OVS Hardware Offload<a class="headerlink" href="#ovs-hardware-offload" title="Permalink to this headline">¶</a></h1>
<p>The OVS software based solution is CPU intensive, affecting system performance
and preventing fully utilizing available bandwidth. OVS 2.8 and above support
new feature called OVS Hardware Offload which improves performance significantly.
This feature allows to offload the OVS data-plane to the NIC while maintaining
OVS control-plane unmodified. It is using SR-IOV technology with VF representor
host net-device. The VF representor plays the same role as TAP devices
in Para-Virtual (PV) setup. A packet sent through the VF representor on the host
arrives to the VF, and a packet sent through the VF is received by its representor.</p>
<div class="section" id="supported-ethernet-controllers">
<h2>Supported Ethernet controllers<a class="headerlink" href="#supported-ethernet-controllers" title="Permalink to this headline">¶</a></h2>
<p>The following manufacturers are known to work:</p>
<ul class="simple">
<li><p>Mellanox ConnectX-5 NIC</p></li>
</ul>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Linux Kernel TBD (require connection tracking offload - https://lwn.net/Articles/793082/)</p></li>
<li><p>Open vSwitch TBD (require connection tracking offload - https://mail.openvswitch.org/pipermail/ovs-dev/2019-July/360376.html)</p></li>
<li><p>iproute &gt;= 4.12</p></li>
<li><p>sriov-device-plugin</p></li>
<li><p>multus-cni</p></li>
</ul>
</div>
<div class="section" id="worker-node-sr-iov-configuration">
<h2>Worker Node SR-IOV Configuration<a class="headerlink" href="#worker-node-sr-iov-configuration" title="Permalink to this headline">¶</a></h2>
<p>In order to enable Open vSwitch hardware offloading, the following steps
are required. Please make sure you have root privileges to run the commands
below.</p>
<p>Check the Number of VF Supported on the NIC</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">enp3s0f0</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">sriov_totalvfs</span>
<span class="mi">8</span>
</pre></div>
</div>
<p>Create the VFs</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;4&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">enp3s0f0</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="n">sriov_numvfs</span>
</pre></div>
</div>
<p>Verfiy the VFs are created</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">link</span> <span class="n">show</span> <span class="n">enp3s0f0</span>
<span class="mi">8</span><span class="p">:</span> <span class="n">enp3s0f0</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">mq</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">mode</span> <span class="n">DEFAULT</span> <span class="n">qlen</span> <span class="mi">1000</span>
   <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="n">a0</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">9</span><span class="n">f</span><span class="p">:</span><span class="mi">8</span><span class="n">f</span><span class="p">:</span><span class="mi">3</span><span class="n">f</span><span class="p">:</span><span class="n">b8</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
   <span class="n">vf</span> <span class="mi">0</span> <span class="n">MAC</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">spoof</span> <span class="n">checking</span> <span class="n">on</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="n">state</span> <span class="n">auto</span>
   <span class="n">vf</span> <span class="mi">1</span> <span class="n">MAC</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">spoof</span> <span class="n">checking</span> <span class="n">on</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="n">state</span> <span class="n">auto</span>
   <span class="n">vf</span> <span class="mi">2</span> <span class="n">MAC</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">spoof</span> <span class="n">checking</span> <span class="n">on</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="n">state</span> <span class="n">auto</span>
   <span class="n">vf</span> <span class="mi">3</span> <span class="n">MAC</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">spoof</span> <span class="n">checking</span> <span class="n">on</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="n">state</span> <span class="n">auto</span>
</pre></div>
</div>
<p>Setup the PF to be up</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">link</span> <span class="nb">set</span> <span class="n">enp3s0f0</span> <span class="n">up</span>
</pre></div>
</div>
<p>Unbind the VFs from the driver</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.2</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">unbind</span>
<span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.3</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">unbind</span>
<span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.4</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">unbind</span>
<span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.5</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">unbind</span>
</pre></div>
</div>
<p>Configure SR-IOV VFs to switchdev mode</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">devlink</span> <span class="n">dev</span> <span class="n">eswitch</span> <span class="nb">set</span> <span class="n">pci</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">mode</span> <span class="n">switchdev</span>
<span class="n">ethtool</span> <span class="o">-</span><span class="n">K</span> <span class="n">enp3s0f0</span> <span class="n">hw</span><span class="o">-</span><span class="n">tc</span><span class="o">-</span><span class="n">offload</span> <span class="n">on</span>
</pre></div>
</div>
<p>Bind the VFs to the driver</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.2</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">bind</span>
<span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.3</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">bind</span>
<span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.4</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">bind</span>
<span class="n">echo</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.5</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">mlx5_core</span><span class="o">/</span><span class="n">bind</span>
</pre></div>
</div>
<p>Set hw-offload=true restart Open vSwitch</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">openvswitch</span><span class="o">.</span><span class="n">service</span>
<span class="n">ovs</span><span class="o">-</span><span class="n">vsctl</span> <span class="nb">set</span> <span class="n">Open_vSwitch</span> <span class="o">.</span> <span class="n">other_config</span><span class="p">:</span><span class="n">hw</span><span class="o">-</span><span class="n">offload</span><span class="o">=</span><span class="n">true</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">openvswitch</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</div>
<div class="section" id="worker-node-sr-iov-network-device-plugin-configuration">
<h2>Worker Node SR-IOV network device plugin configuration<a class="headerlink" href="#worker-node-sr-iov-network-device-plugin-configuration" title="Permalink to this headline">¶</a></h2>
<p>This plugin creates device plugin endpoints based on the configurations given in file <code class="docutils literal notranslate"><span class="pre">/etc/pcidp/config.json</span></code>.
This configuration file is in json format as shown below:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;resourceList&quot;</span><span class="p">:</span> <span class="p">[</span>
         <span class="p">{</span>
            <span class="nt">&quot;resourceName&quot;</span><span class="p">:</span> <span class="s2">&quot;cx5_sriov_switchdev&quot;</span><span class="p">,</span>
            <span class="nt">&quot;selectors&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;vendors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;15b3&quot;</span><span class="p">],</span>
                <span class="nt">&quot;devices&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1018&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Deploy SR-IOV network device plugin as daemonset see https://github.com/intel/sriov-network-device-plugin</p>
</div>
<div class="section" id="worker-node-multus-cni-configuration">
<h2>Worker Node Multus CNI configuration<a class="headerlink" href="#worker-node-multus-cni-configuration" title="Permalink to this headline">¶</a></h2>
<p>Multus Config</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;multus-cni-network&quot;</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;multus&quot;</span><span class="p">,</span>
  <span class="nt">&quot;clusterNetwork&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="nt">&quot;defaultNetworks&quot;</span><span class="p">:[],</span>
  <span class="nt">&quot;kubeconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/kubernetes/node-kubeconfig.yaml&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Deploy multus CNI as daemonset see https://github.com/intel/multus-cni</p>
<p>Create NetworkAttachementDefinition CRD with OVN CNI config</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">Kubernetes Network CRD Spec</span><span class="p">:</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">k8s.v1.cni.cncf.io/resourceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mellanox.com/cx5_sriov_switchdev</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">Config</span><span class="p">:</span> <span class="s">&#39;{&quot;cniVersion&quot;:&quot;0.3.1&quot;,&quot;name&quot;:&quot;ovn-kubernetes&quot;,&quot;type&quot;:&quot;ovn-k8s-cni-overlay&quot;,&quot;ipam&quot;:{},&quot;dns&quot;:{}}&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-pod-with-ovs-hardware-offload">
<h2>Deploy POD with OVS hardware-offload<a class="headerlink" href="#deploy-pod-with-ovs-hardware-offload" title="Permalink to this headline">¶</a></h2>
<p>Create POD spec and</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ovs-offload-pod1</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">v1.multus-cni.io/default-network</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">appcntr1</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">centos/tools</span>
    <span class="nt">resources</span><span class="p">:</span>
      <span class="nt">requests</span><span class="p">:</span>
        <span class="nt">mellanox.com/cx5_sriov_switchdev</span><span class="p">:</span> <span class="s">&#39;1&#39;</span>
      <span class="nt">limits</span><span class="p">:</span>
        <span class="nt">mellanox.com/cx5_sriov_switchdev</span><span class="p">:</span> <span class="s">&#39;1&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="verify-hardware-offload-is-working">
<h2>Verify Hardware-Offload is working<a class="headerlink" href="#verify-hardware-offload-is-working" title="Permalink to this headline">¶</a></h2>
<p>Lookup VF representor, in this example it is e5a1c8fcef0f327</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ip link show enp3s0f0
6: enp3s0f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq master ovs-system state UP mode DEFAULT group default qlen 1000
   link/ether ec:0d:9a:46:9e:84 brd ff:ff:ff:ff:ff:ff
   vf 0 MAC 00:00:00:00:00:00, spoof checking off, link-state enable, trust off, query_rss off
   vf 1 MAC 00:00:00:00:00:00, spoof checking off, link-state enable, trust off, query_rss off
   vf 2 MAC 00:00:00:00:00:00, spoof checking off, link-state enable, trust off, query_rss off
   vf 3 MAC fa:16:3e:b9:b8:ce, vlan 57, spoof checking on, link-state enable, trust off, query_rss off

compute_node2# ls -l /sys/class/net/
lrwxrwxrwx 1 root root 0 Sep 11 10:54 eth0 -&gt; ../../devices/virtual/net/eth0
lrwxrwxrwx 1 root root 0 Sep 11 10:54 eth1 -&gt; ../../devices/virtual/net/eth1
lrwxrwxrwx 1 root root 0 Sep 11 10:54 eth2 -&gt; ../../devices/virtual/net/eth2
lrwxrwxrwx 1 root root 0 Sep 11 10:54 e5a1c8fcef0f327 -&gt; ../../devices/virtual/net/e5a1c8fcef0f327
</pre></div>
</div>
<p>Access the POD</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">ovs</span><span class="o">-</span><span class="n">offload</span><span class="o">-</span><span class="n">pod1</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p>Ping other POD on second worker node</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ping</span> <span class="n">ovs</span><span class="o">-</span><span class="n">offload</span><span class="o">-</span><span class="n">pod2</span>
</pre></div>
</div>
<p>Check traffic on the VF representor port. Verify that only the first ICMP packet appears</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tcpdump</span> <span class="o">-</span><span class="n">nnn</span> <span class="o">-</span><span class="n">i</span> <span class="n">e5a1c8fcef0f327</span>

<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="ow">or</span> <span class="o">-</span><span class="n">vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mf">41.260487</span> <span class="n">IP</span> <span class="mf">172.0.0.13</span> <span class="o">&gt;</span> <span class="mf">172.0.0.10</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1263</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">64</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mf">41.260778</span> <span class="n">IP</span> <span class="mf">172.0.0.10</span> <span class="o">&gt;</span> <span class="mf">172.0.0.13</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">reply</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1263</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">64</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mf">46.268951</span> <span class="n">ARP</span><span class="p">,</span> <span class="n">Request</span> <span class="n">who</span><span class="o">-</span><span class="n">has</span> <span class="mf">172.0.0.13</span> <span class="n">tell</span> <span class="mf">172.0.0.10</span><span class="p">,</span> <span class="n">length</span> <span class="mi">42</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mf">46.271771</span> <span class="n">ARP</span><span class="p">,</span> <span class="n">Reply</span> <span class="mf">172.0.0.13</span> <span class="ow">is</span><span class="o">-</span><span class="n">at</span> <span class="n">fa</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">3</span><span class="n">e</span><span class="p">:</span><span class="mi">1</span><span class="n">a</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">,</span> <span class="n">length</span> <span class="mi">46</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mf">55.354737</span> <span class="n">IP6</span> <span class="n">fe80</span><span class="p">::</span><span class="n">f816</span><span class="p">:</span><span class="mi">3</span><span class="n">eff</span><span class="p">:</span><span class="n">fe29</span><span class="p">:</span><span class="mi">8118</span> <span class="o">&gt;</span> <span class="n">ff02</span><span class="p">::</span><span class="mi">1</span><span class="p">:</span> <span class="n">ICMP6</span><span class="p">,</span> <span class="n">router</span> <span class="n">advertisement</span><span class="p">,</span> <span class="n">length</span> <span class="mi">64</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mf">56.106705</span> <span class="n">IP</span> <span class="mf">0.0.0.0.68</span> <span class="o">&gt;</span> <span class="mf">255.255.255.255.67</span><span class="p">:</span> <span class="n">BOOTP</span><span class="o">/</span><span class="n">DHCP</span><span class="p">,</span> <span class="n">Request</span> <span class="kn">from</span> <span class="mi">62</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="n">f0</span><span class="p">:</span><span class="mi">89</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">73</span><span class="p">,</span> <span class="n">length</span> <span class="mi">30</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="design/shared_gw_dgp.html" class="btn btn-neutral float-right" title="Enable Node-Local Services Access in Shared Gateway Mode" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="kind.html" class="btn btn-neutral float-left" title="OVN kubernetes KIND Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, OpenShift SDN Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>