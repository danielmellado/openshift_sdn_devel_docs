

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>CI Tests &mdash; OpenShift SDN Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Config variables" href="config.html" />
    <link rel="prev" title="Generate signed certificates for OVN Northd" href="OVN-NORTHD.SSL.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> OpenShift SDN Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">OpenShift SDN devel docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cno/index.html">Cluster Network Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift_sdn/index.html">OpenShift SDN</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">OVN-Kubernetes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../README.html">How to use Open Virtual Networking with Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README_MANUAL.html">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README_MANUAL.html#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README_MANUAL.html#installing-kubernetes">Installing Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kind.html">Fedora 32 setup for KIND</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.UBUNTU.html">Installing OVS and OVN on Ubuntu</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.SSL.html">Generating certificates</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.SSL.html#one-time-setup">One time setup.</a></li>
<li class="toctree-l2"><a class="reference internal" href="INSTALL.OPENSHIFT.html">OVN overlay network on Openshift</a></li>
<li class="toctree-l2"><a class="reference internal" href="OVN-NORTHD.SSL.html">Generate signed certificates for OVN Northd</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">CI Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#updating-ci-test-suite">Updating CI Test Suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-ci-locally">Running CI Locally</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#download-and-build-kubernetes-components">Download and Build Kubernetes Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kind">KIND</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-tests">Run Tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Config variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Config variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Initial setup issues.</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html#hosts-should-have-unique-node-names">Hosts should have unique node names.</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html#runtime-issues">Runtime issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="egress-firewall.html">EgressFirewall</a></li>
<li class="toctree-l2"><a class="reference internal" href="ha.html">OVN central database High-availability</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid-overlay.html">Hybrid Overlay</a></li>
<li class="toctree-l2"><a class="reference internal" href="kind.html">OVN kubernetes KIND Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="ovs_offload.html">OVS Hardware Offload</a></li>
<li class="toctree-l2"><a class="reference internal" href="design/shared_gw_dgp.html">Enable Node-Local Services Access in Shared Gateway Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="ovn-kubernetes-basics.html">OVN Kubernetes Basics</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OpenShift SDN Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">OVN-Kubernetes</a> &raquo;</li>
        
      <li>CI Tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/ovn_kubernetes/docs/ci.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ci-tests">
<h1>CI Tests<a class="headerlink" href="#ci-tests" title="Permalink to this headline">¶</a></h1>
<p>For CI, OVN-Kubernetes runs the
<a class="reference external" href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/e2e-tests.md">Kubernetes E2E tests</a>
and some locally defined tests.
<a class="reference external" href="https://help.github.com/en/actions">GitHub Actions</a>
are used to run a subset of the Kubernetes E2E tests on each pull request. The
local workflow that controls the test run is located in
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/.github/workflows/test.yml">ovn-kubernetes/.github/workflows/test.yml</a>.</p>
<p>The following tasks are performed:</p>
<ul class="simple">
<li><p>Builds OVN-Kubernetes</p></li>
<li><p>Checks out the Kubernetes source tree and compiles some dependencies</p></li>
<li><p>Installs KIND</p></li>
<li><p>Runs a matrix of End-To-End Tests using KIND</p></li>
</ul>
<p>Below describes how to update the set of tests that run and how to run these
tests locally.</p>
<div class="section" id="updating-ci-test-suite">
<h2>Updating CI Test Suite<a class="headerlink" href="#updating-ci-test-suite" title="Permalink to this headline">¶</a></h2>
<p>The tests are broken into a set of shards, which is just a grouping of tests,
and each shard is run in a separate job in parallel. Below is an example of
the shards (which may change in the future):</p>
<ul class="simple">
<li><p>shard-n-other</p>
<ul>
<li><p>All E2E tests that match <code class="docutils literal notranslate"><span class="pre">[sig-network]</span> <span class="pre">N</span></code> and do NOT have P as their sixth
letter after the N (i.e. Roughly all <code class="docutils literal notranslate"><span class="pre">[sig-network]</span> <span class="pre">Networking</span> <span class="pre">...</span></code> tests.), and all other tests
that don’t match the rule below</p></li>
</ul>
</li>
<li><p>shard-np</p>
<ul>
<li><p>All E2E tests that match <code class="docutils literal notranslate"><span class="pre">[sig-network]</span> <span class="pre">N</span></code> and DO have a P as their sixth
letter after the N. (i.e. Roughly all <code class="docutils literal notranslate"><span class="pre">[sig-network]</span> <span class="pre">NetworkPolicy</span> <span class="pre">...</span></code>
tests.)</p></li>
</ul>
</li>
<li><p>shard-test</p>
<ul>
<li><p>Single E2E test that matches the name of the test specified with a regex. See bottom of this document for an example.</p></li>
</ul>
</li>
<li><p>control-plane</p>
<ul>
<li><p>All locally defined tests.</p></li>
</ul>
</li>
</ul>
<p>The regex expression for determining which E2E test is run in which shard, as
well as the list of skipped tests is defined in
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/test/scripts/e2e-kind.sh">ovn-kubernetes/test/scripts/e2e-kind.sh</a>. The local tests are controlled in
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/test/scripts/e2e-cp.sh">ovn-kubernetes/test/scripts/e2e-cp.sh</a>
and the actual tests are defined in the directory
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/tree/master/test/e2e">ovn-kubernetes/test/e2e/</a>.</p>
<p>Each of these shards can then be run in a matrix of:</p>
<ul class="simple">
<li><p>HA setup (3 masters and 0 workers) and a non-HA setup (1 master and 2 workers)</p></li>
<li><p>Local Gateway Mode and Shared Gateway Mode. See:
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/docs/design/shared_gw_dgp.md">Enable Node-Local Services Access in Shared Gateway Mode</a></p></li>
<li><p>IPv4 Only and IPv6 Only</p></li>
</ul>
<p>To reduce the explosion of tests being run in CI, the test case run are limited
using an <code class="docutils literal notranslate"><span class="pre">exclude:</span></code> statement in
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/.github/workflows/test.yml">ovn-kubernetes/.github/workflows/test.yml</a>.</p>
</div>
<div class="section" id="running-ci-locally">
<h2>Running CI Locally<a class="headerlink" href="#running-ci-locally" title="Permalink to this headline">¶</a></h2>
<p>This section describes how to run CI tests on a local deployment. This may be
useful for expanding the CI test coverage or testing a private fix before
creating a pull request.</p>
<div class="section" id="download-and-build-kubernetes-components">
<h3>Download and Build Kubernetes Components<a class="headerlink" href="#download-and-build-kubernetes-components" title="Permalink to this headline">¶</a></h3>
<div class="section" id="go-version">
<h4>Go Version<a class="headerlink" href="#go-version" title="Permalink to this headline">¶</a></h4>
<p>Older versions of Kubernetes do not build with newer versions of Go,
specifically Kubernetes v1.16.4 doesn’t build with Go version 1.13.x. If this is
a version of Kubernetes that needs to be tested with, as a workaround, Go
version 1.12.1 can be downloaded to a local directory and the $PATH variable
updated only where kubernetes is being built.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ go version
go version go1.13.8 linux/amd64

$ mkdir -p /home/$USER/src/golang/go1-12-1/; cd /home/$USER/src/golang/go1-12-1/
$ wget https://dl.google.com/go/go1.12.1.linux-amd64.tar.gz
$ tar -xzf go1.12.1.linux-amd64.tar.gz
$ PATH=/home/$USER/src/golang/go1-12-1/go/bin:$GOPATH/src/k8s.io/kubernetes/_output/local/bin/linux/amd64:$PATH
</pre></div>
</div>
</div>
<div class="section" id="download-and-build-kubernetes-components-e2e-tests-ginkgo-kubectl">
<h4>Download and Build Kubernetes Components (E2E Tests, ginkgo, kubectl):<a class="headerlink" href="#download-and-build-kubernetes-components-e2e-tests-ginkgo-kubectl" title="Permalink to this headline">¶</a></h4>
<p>Determine which version of Kubernetes is currently used in CI (See
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/.github/workflows/test.yml">ovn-kubernetes/.github/workflows/test.yml</a>)
and set the environmental variable <code class="docutils literal notranslate"><span class="pre">K8S_VERSION</span></code> to the same value.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>K8S_VERSION=v1.17.2
git clone --single-branch --branch $K8S_VERSION https://github.com/kubernetes/kubernetes.git $GOPATH/src/k8s.io/kubernetes/
pushd $GOPATH/src/k8s.io/kubernetes/
make WHAT=&quot;test/e2e/e2e.test vendor/github.com/onsi/ginkgo/ginkgo cmd/kubectl&quot;
rm -rf .git

cp _output/local/go/bin/e2e.test $GOPATH/bin/.

sudo cp /usr/bin/kubectl /usr/bin/kubectl.bak
sudo cp _output/local/go/bin/kubectl /usr/bin/kubectl-$K8S_VERSION
sudo ln -s /usr/bin/kubectl-$K8S_VERSION /usr/bin/kubectl
popd
</pre></div>
</div>
<p>If you have any failures during the build, verify $PATH has been updated to
point to correct GO version. Also may need to change settings on some of the
generated binaries. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>chmod +x $GOPATH/src/k8s.io/kubernetes/_output/bin/deepcopy-gen
</pre></div>
</div>
</div>
</div>
<div class="section" id="kind">
<h3>KIND<a class="headerlink" href="#kind" title="Permalink to this headline">¶</a></h3>
<p>Kubernetes in Docker (KIND) is used to deploy Kubernetes locally where a docker
container is created per Kubernetes node. The CI tests run on this Kubernetes
deployment. Therefore, KIND will need to be installed locally.</p>
<p>Instructions for installing and running KIND can be found at:
https://github.com/ovn-org/ovn-kubernetes/blob/master/docs/kind.md</p>
</div>
<div class="section" id="run-tests">
<h3>Run Tests<a class="headerlink" href="#run-tests" title="Permalink to this headline">¶</a></h3>
<p>To run the tests locally, run a KIND deployment as described above. The E2E
tests look for the kube config file in a special location, so make a copy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">~/</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span> <span class="o">~/.</span><span class="n">kube</span><span class="o">/</span><span class="n">kind</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">kind</span>
</pre></div>
</div>
<p>To run the desired shard, use the following (each shard can take +30 mins to
run):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd $GOPATH/src/github.com/ovn-org/ovn-kubernetes

$ pushd test
$ make shard-n-other
$ make shard-np
$ GITHUB_WORKSPACE=$GOPATH/src/github.com/ovn-org/ovn-kubernetes make control-plane
$ popd
</pre></div>
</div>
<p>To run a single test instead, target the shard-test action, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd $GOPATH/src/github.com/ovn-org/ovn-kubernetes
$ pushd test
$ make shard-test WHAT=&quot;should enforce egress policy allowing traffic to a server in a different namespace based on PodSelector and NamespaceSelector&quot;
$ popd
</pre></div>
</div>
<p>To skip the IPv4 only tests (in a IPv6 only deployment), pass the
<code class="docutils literal notranslate"><span class="pre">KIND_IPV6_SUPPORT=true</span></code> environmental variable to <code class="docutils literal notranslate"><span class="pre">make</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd $GOPATH/src/github.com/ovn-org/ovn-kubernetes

$ pushd test
$ KIND_IPV6_SUPPORT=true make shard-n-other
$ popd
</pre></div>
</div>
<p>Github CI doesn´t offer IPv6 connectivity, so IPv6 only tests are always
skipped. To run those tests locally, comment out the following line from
<a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/test/scripts/e2e-kind.sh">ovn-kubernetes/test/scripts/e2e-kind.sh</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Github CI doesn´t offer IPv6 connectivity, so always skip IPv6 only tests.
SKIPPED_TESTS=$SKIPPED_TESTS$IPV6_ONLY_TESTS
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="config.html" class="btn btn-neutral float-right" title="Config variables" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="OVN-NORTHD.SSL.html" class="btn btn-neutral float-left" title="Generate signed certificates for OVN Northd" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, OpenShift SDN Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>